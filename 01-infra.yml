---
- name: ensure bastion and infra
  hosts: localhost
  connection: local
  module_defaults:
    group/hetzner.hcloud.all:
      api_token: "{{ vault_hetzner_token }}"

  tasks:

    - name: Ensure SSH key
      hetzner.hcloud.ssh_key:
        name: hetzner-admin
        public_key: "{{ ssh_admin_key }}"
        state: present

    - name: Create a firewall for bastion
      hetzner.hcloud.firewall:
        name: bastion-firewall
        rules:
          - description: allow icmp from everywhere
            direction: in
            protocol: icmp
            source_ips:
              - 0.0.0.0/0
              - ::/0
          - description: allow ssh
            direction: in
            protocol: tcp
            port: 22
            source_ips:
              - 0.0.0.0/0
              - ::/0
        state: present

    - name: Create bastion
      hetzner.hcloud.server:
        name: bastion
        server_type: cpx11
        datacenter: hel1-dc2
        image: centos-stream-10
        ssh_keys:
          - hetzner-admin
        firewalls:
          - bastion-firewall
        labels:
          role: bastion
        state: started
      register: bastion_vm

    - name: Refresh inventory to get access to servers
      meta: refresh_inventory

    - name: wait bastion
      wait_for:
        host: "{{ hostvars[groups['role_bastion'][0]]['hcloud_ipv4'] }}"
        port: 22
        delay: 2
      delegate_to: localhost

    - debug:
        msg: "Bastion at: {{ hostvars[groups['role_bastion'][0]]['hcloud_ipv4'] }}"
